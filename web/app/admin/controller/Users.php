<?php

namespace app\admin\controller;

use think\Db;
use think\Exception;
use think\Log;
use think\Request;
use think\Controller;
use app\admin\model\Users as UsersModel;

class Users extends Common
{
    private $client;


    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub

        $this->client = new \JdcClient(config('rpc_host'), config('rpc_port'), config('rpc_user'), config('rpc_password'));
    }

    //会员列表
    public function index()
    {
        if (request()->isPost()) {
            $where = [];
            $where['u.deleted'] = 0;
            $key = input('post.key');
            if ($key != '') {
                $where['u.mobile|u.username|u.number|u.user_id'] = $key;
            }
            $user_level = input('post.user_level');
            if ($user_level != '') {
                $where['u.user_level'] = $user_level;
            }
            $matching_level = input('post.matching_level');
            if ($matching_level != '') {
                $where['u.matching_level'] = $matching_level;
            }
            $select_status3 = input('post.select_status3');
            if ($select_status3 != '') {
                $where['ur.final_level'] = $select_status3;
            }
            $select_status4 = input('post.select_status4');
            if ($select_status4 == 1) {
                $where['u.shareholder_rate'] = ['gt', 0];
            }
            if ($select_status4 == -1) {
                $where['u.shareholder_rate'] = ['eq', 0];
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');

            $list = db('users')->alias('u')
                ->join('user_rela ur', 'u.user_id=ur.user_id')
                ->join('idaudit id', 'u.user_id=id.user_id', 'left')
                ->join('idaudit i', 'u.pid=i.user_id', 'left')
                ->join('users s', 's.user_id=ur.pid', 'left')
                ->where($where)
                ->field("u.matching_level,u.shareholder_rate,u.user_id,u.username,u.number,u.mobile,u.invite,u.pid,u.user_level,INET_NTOA(u.reg_ip) as reg_ip,u.is_crowd,u.status,FROM_UNIXTIME(u.addtime) addtime,u.freeze_time,FROM_UNIXTIME(u.`update`) `update`,ur.vip_node,id.id_name,ur.buy_total,ur.team_total,s.address as p_address,s.mobile as p_mobile,i.id_name as p_name,ur.team,ur.user_level user_level2,ur.admin_level,ur.final_level")
                ->order('u.user_id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();

            foreach ($list['data'] as $k => $v) {
                if ($v['freeze_time'] != null) {
                    $list['data'][$k]['freeze_time'] = date('Y-m-d H:i:s', $v['freeze_time']);
                }
                $list['data'][$k]['fact_level'] = db('matching')->where(['min' => ['elt', $v['team_total']], 'max' => ['egt', $v['team_total']]])->value('matching_id');
                //$list['data'][$k]['reg_time'] = date('Y-m-d H:i', $v['reg_time']);
                //$list['data'][$k]['reg_ip'] = long2ip($v['reg_ip']);
            }
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //清空不良记录
    public function usersCheck()
    {
        $id = input('id');
        $res = db('users')->where(array('user_id' => $id))->update(['freeze_time' => 0]);
        if ($res) {
            return ['msg' => '清空不良记录成功!', 'url' => url('index'), 'code' => 1];
        } else {
            return ['msg' => '清除不良记录失败!', 'url' => url('index'), 'code' => 1];
        }
    }

    //清空不良记录
    public function usersSuperior()
    {
        $user_id = input('id');
        $page = input('page') ? input('page') : 1;
        $pageSize = input('limit') ? input('limit') : config('pageSize');
        $user = Db('user_rela')->where(array('user_id' => $user_id))->field('lft,rgt')->find();

        $data = Db('user_rela')->alias('r')
            ->join('users u', 'r.user_id=u.user_id')
            ->join('idaudit i', 'r.user_id=i.user_id', 'left')
            ->where(['r.lft' => ['gt', $user['lft']], 'r.rgt' => ['lt', $user['rgt']]])->field('u.mobile,FROM_UNIXTIME(u.addtime) addtime,u.address,r.user_id,i.id_name')
            ->order('r.direct desc,buy_total desc')
            ->paginate(array('list_rows' => $pageSize, 'page' => $page))
            ->toArray();

        foreach ($data['data'] as $K => $v) {
            $data['data'][$K]['USDT'] = Db('user_coin')->where(['user_id' => $v['user_id'], 'coin_id' => 2])->value('balance');
            $data['data'][$K]['IDO'] = Db('user_coin')->where(['user_id' => $v['user_id'], 'coin_id' => 1])->value('balance');
            $data['data'][$K]['ACF'] = Db('user_coin')->where(['user_id' => $v['user_id'], 'coin_id' => 23])->value('balance');
        }

        return ['data' => $data, 'code' => 1];

    }

    public function usersStatus()
    {
        $id = input('post.id');
        $status = input('post.status');
        //$status = db('users')->where(array('user_id' => $id))->value('status');//判断当前状态情况
        Db::startTrans();
        try {
            if ($status == 1) {
                $data['status'] = 0;
                db('users')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                //db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 1, 'union' => 'users', 'union_id' => $id, 'object' => '会员禁用：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                //退出登陆
                //cache('cache_userinfo_' . $id, null);
                $result['status'] = 0;
                $result['code'] = 1;
            } else {
                $data['status'] = 1;
                db('users')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                // db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 2, 'union' => 'users', 'union_id' => $id, 'object' => '会员开启：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                $result['status'] = 1;
                $result['code'] = 1;
            }
            Db::commit();
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    public function is_crowd()
    {
        $id = input('post.id');
        $is_crowd = input('post.is_crowd');
        //$status = db('users')->where(array('user_id' => $id))->value('status');//判断当前状态情况
        Db::startTrans();
        try {
            if ($is_crowd == 1) {
                $data['is_crowd'] = 1;
                db('users')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                //db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 1, 'union' => 'users', 'union_id' => $id, 'object' => '会员禁用：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                //退出登陆
                //cache('cache_userinfo_' . $id, null);
                $result['is_crowd'] = 1;
                $result['code'] = 1;
            } else {
                $data['is_crowd'] = 0;
                db('users')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                // db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 2, 'union' => 'users', 'union_id' => $id, 'object' => '会员开启：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                $result['is_crowd'] = 0;
                $result['code'] = 1;
            }
            Db::commit();
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    public function userNode()
    {
        $id = input('post.id');
        $node = input('post.node');
        //$status = db('users')->where(array('user_id' => $id))->value('status');//判断当前状态情况
        Db::startTrans();
        try {
            if ($node == 1) {
                $data['node'] = 0;
                db('user_rela')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                //db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 1, 'union' => 'users', 'union_id' => $id, 'object' => '会员禁用：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                //退出登陆
                //cache('cache_userinfo_' . $id, null);
                $result['node'] = 0;
                $result['code'] = 1;
            } else {
                $data['node'] = 1;
                db('user_rela')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                // db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 2, 'union' => 'users', 'union_id' => $id, 'object' => '会员开启：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                $result['node'] = 1;
                $result['code'] = 1;
            }
            Db::commit();
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    public function userVipNode()
    {
        $id = input('post.id');
        $vip_node = input('post.vip_node');
        //$status = db('users')->where(array('user_id' => $id))->value('status');//判断当前状态情况
        Db::startTrans();
        try {
            if ($vip_node == 1) {
                $data['vip_node'] = 1;
                db('user_rela')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                //db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 1, 'union' => 'users', 'union_id' => $id, 'object' => '会员禁用：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                //退出登陆
                //cache('cache_userinfo_' . $id, null);
                $result['vip_node'] = 1;
                $result['code'] = 1;
            } else {
                $data['vip_node'] = 0;
                db('user_rela')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                // db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 2, 'union' => 'users', 'union_id' => $id, 'object' => '会员开启：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                $result['vip_node'] = 0;
                $result['code'] = 1;
            }
            Db::commit();
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    public function usersDel()
    {
        $id = input('id');
        $res = db('users')->where(array('user_id' => $id))->update(['deleted' => 1]);
        if ($res) {
            return ['msg' => '会员删除成功!', 'url' => url('index'), 'code' => 1];
        } else {
            return ['msg' => '会员删除失败!', 'url' => url('index'), 'code' => 1];
        }

    }

    public function usersState()
    {
        $id = input('post.id');
        $title = input('post.title');
        $status = db('users')->where(array('user_id' => $id))->value('status');//判断当前状态情况
        Db::startTrans();
        try {
            if ($status == 1) {
                $data['status'] = 0;
                db('users')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 1, 'union' => 'users', 'union_id' => $id, 'object' => '会员禁用：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                //退出登陆
                cache('cache_userinfo_' . $id, null);
                $result['status'] = 0;
                $result['code'] = 1;
            } else {
                $data['status'] = 1;
                db('users')->where(array('user_id' => $id))->setField($data);
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 2, 'union' => 'users', 'union_id' => $id, 'object' => '会员开启：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                $result['status'] = 1;
                $result['code'] = 1;
            }
            Db::commit();
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    public function edit($id = '')
    {
        $date = date('Ymd');
        if (request()->isPost()) {
            $data = input('post.');
            $data['user_id'] = $id;
            $code = explode(':', $data['code']);
            $data['code'] = $code[1];
            $user_msg = Db('users')->alias('u')->join('user_rela ur', 'u.user_id=ur.user_id')->where('u.user_id', $data['user_id'])->field('u.user_id,u.code,u.mobile,u.username,u.matching_level,ur.admin_level,ur.user_level,u.shareholder_rate')->find();
            Db::startTrans();
            try {
                if ($user_msg['username'] != $data['username']) {//修改手机号
                    //判断用户名是否存在
                    if (Db::name('users')->where('username', $data['username'])->count()) {
                        Db::rollback();
                        return ['code' => 0, 'msg' => '用户名已存在!'];
                    } else {
                        $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 9, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员修改昵称，' . $user_msg['username'] . '==>' . $data['username'], 'last_time' => time(), 'ip' => request()->ip(1));
                    }

                }
//                if ($user_msg['mobile'] != $data['mobile'] || $user_msg['code'] != $data['code']) {//修改手机号
//                    $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 8, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员修改手机，' . $user_msg['code'] . '-' . $user_msg['mobile'] . '==>' . $data['code'] . '-' . $data['mobile'], 'last_time' => time(), 'ip' => request()->ip(1));
//                }

                //修改匹配级别
                if ($user_msg['matching_level'] != $data['matching_level']) {
                    //修改今天上午场匹配等级
                    if ($data['matching_level'] != 0) {
                        db('trade')->where(['user_id' => $data['user_id'], 'date' => date('Ymd'), 'type' => 2, 'status' => 0])->update(['admin_level' => $data['matching_level'], 'final_level' => $data['matching_level']]);
                    } else {
                        Db::connect()->execute("update tp_trade set `admin_level`=0,`final_level` = `fact_level` where `user_id`={$data['user_id']} and `date`={$date} and `type`=2 and `status`=0 ");
                    }
                    if ($_SESSION['session']['aid'] == 1) {
                        $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 12, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员修改匹配级别，' . $user_msg['matching_level'] . '==>' . $data['matching_level'], 'last_time' => time(), 'ip' => request()->ip(1));
                    }
                }

                //修改会员等级
                if ($user_msg['admin_level'] != $data['admin_level']) {
                    if ($data['admin_level'] != 0) {
                        db('user_rela')->where(['user_id' => $user_msg['user_id']])->update(['admin_level' => $data['admin_level'], 'final_level' => $data['admin_level']]);
                    } else {
                        db('user_rela')->where(['user_id' => $user_msg['user_id']])->update(['admin_level' => 0, 'final_level' => $user_msg['user_level']]);
                    }
                    $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 12, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员修改等级，' . $user_msg['admin_level'] . '==>' . $data['admin_level'], 'last_time' => time(), 'ip' => request()->ip(1));
                    unset($data['admin_level']);
                }

                //修改股东分成
                if ($user_msg['shareholder_rate'] != $data['shareholder_rate']) {
                    $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 13, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员修改股东分成，' . $user_msg['shareholder_rate'] . '==>' . $data['shareholder_rate'], 'last_time' => time(), 'ip' => request()->ip(1));
                }

                if ($data['idreset']) {//这里删除用户实名信息
                    $imgs = Db('user_idaudit')->where('user_id', $data['user_id'])->field('front_attach_id,back_attach_id,hand_attach_id')->find();
                    Db('attach')->where(['attach_id' => ['in', $imgs]])->delete();//删除图片
                    Db('user_idaudit')->where('user_id', $data['user_id'])->delete();
                    $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 7, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员清空实名', 'last_time' => time(), 'ip' => request()->ip(1));
                }

                if (empty($data['password'])) {
                    unset($data['password']);
                } else {//修改密码
                    $data['password'] = md5(md5($data['password']) . config('password_str'));
                    $log[] = array('admin_name' => $_SESSION['session']['username'], 'type' => 6, 'union' => 'users', 'union_id' => $data['user_id'], 'object' => '会员修改密码', 'last_time' => time(), 'ip' => request()->ip(1));
                }
                if ($log) {
                    db('log_action')->insertAll($log);
                }
                db('users')->update($data);
                Db::commit();
                return ['msg' => '会员修改成功!', 'url' => url('index'), 'code' => 1];
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 0, 'msg' => '操作失败!', $e->getMessage()];
            }
        } else {
            $country = db('country')->field('country_id,name,code')->select();
            $info = db('users')->alias('u')->join('user_rela ur', 'u.user_id=ur.user_id')->where(['u.user_id' => $id])->field('u.*,ur.admin_level')->find();
            //var_dump($info);die;
            $this->assign('info', json_encode($info, true));
            $this->assign('country', json_encode($country, true));
            $this->assign('title', lang('edit') . lang('user'));
            return $this->fetch();
        }
    }

    public function userLevel()
    {
        $id = input('post.id');
        $status = db('users')->where(array('user_id' => $id))->value('user_level');//判断当前状态情况
        Db::startTrans();
        try {
            if ($status == 4) {

                if (db('idaudit')->where(['user_id' => $id, 'status' => 1])->count()) {
                    $data['user_level'] = 2;
                } else {
                    $data['user_level'] = 3;
                }

                db('users')->where(array('user_id' => $id))->setField($data);
                db('user_rela')->where(array('user_id' => $id))->update(['vip_node' => 0, 'vip_time' => 0]);
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 1, 'union' => 'users', 'union_id' => $id, 'object' => '取消合伙人：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));

                $result['code'] = 1;
            } else {
                $data['user_level'] = 4;
                db('users')->where(array('user_id' => $id))->setField($data);
                db('user_rela')->where(array('user_id' => $id))->update(['vip_node' => 1, 'vip_time' => time()]);
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 2, 'union' => 'users', 'union_id' => $id, 'object' => '设置合伙人：' . $id, 'last_time' => time(), 'ip' => request()->ip(1)));
                $result['status'] = 4;
                $result['code'] = 1;
            }
            Db::commit();
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    //支付方式
    public function userPayType()
    {
        if (request()->isPost()) {

            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['users.number|up.user_id|up.type|up.payment_account|users.username'] = $key;
            }
            $type = input('post.type');
            if ($type != '') {
                $where['up.type'] = $type;
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('user_payment')->alias('up')//设置数据库别名
            ->join('users', 'up.user_id=users.user_id', 'left')//要关联的表名 关联条件 关联类型
            ->where($where)
                ->field('up.*,FROM_UNIXTIME(up.addtime) addtime,users.username,users.number')//指定一个表的某些字段查询
                ->order('up.addtime desc')//用于对操作的结果排序。
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))//分页方法
                ->toArray();

            foreach ($list['data'] as $k => $v) {
                $list['data'][$k]['type'] = config('user_payment')[$v['type']];
            }

            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //删除支付方式
    public function userPay_del()
    {
        $id = input('post.payment_id');
        $deleted = input('post.deleted');//后面的是post方式传过来的delete字段的值

        db('user_payment')->where('payment_id' . '=' . $id)->update(['deleted' => $deleted]);
        $result['status'] = 1;
        $result['info'] = $deleted;
        $result['url'] = url('userPayType');
        return $result;
    }

    //会员锁仓
    public function userLock()
    {
        if (request()->isPost()) {
            $key = input('post.key');
            if ($key != '') {
                $where['users.number|users.username|ul.user_id'] = $key;
            }
            $status3 = input('post.status3');
            if ($status3 != '') {
                $where['ul.status'] = $status3;
            }
            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['ul.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('user_lock')->alias('ul')//设置数据库别名
            ->join('users', 'ul.user_id = users.user_id', 'left')//要关联的表名 关联条件 关联类型
            ->join('lock', 'ul.lock_id=lock.lock_id', 'left')
                ->join('coin', 'ul.coin_id=coin.coin_id', 'left')
                ->where($where)
                ->field('ul.*,FROM_UNIXTIME(ul.addtime) addtime,FROM_UNIXTIME(ul.endtime) endtime,users.username,users.number,lock.name as lock_name,coin.name')//指定一个表的某些字段查询
                ->order('ul.lock_id desc')//用于对操作的结果排序。
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))//分页方法
                ->toArray();
            foreach ($list['data'] as $k => $v) {
//                $list['data'][$k]['status'] = config('user_lock')[$v['status']];
                if ($v['pick_time'] != 0) {
                    $list['data'][$k]['pick_time'] = date('Y-m-d H:i:s', $v['pick_time']);
                } else {
                    $list['data'][$k]['pick_time'] = null;
                }
            }
            //print_r($list['data']);
            //exit();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //会员锁仓数量
    public function userLockNum()
    {
        if (request()->isPost()) {
            $key = input('post.key');
            if ($key != '') {
                $where['users.number|users.username|ul.user_id'] = $key;
            }

            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('user_lock_num')->alias('ul')//设置数据库别名
            ->join('users', 'ul.user_id = users.user_id', 'left')//要关联的表名 关联条件 关联类型
            ->join('lock', 'ul.lock_id=lock.lock_id', 'left')
                ->where($where)
                ->field('ul.*,users.username,users.number,lock.name')//指定一个表的某些字段查询
                ->order('ul.lock_id desc')//用于对操作的结果排序。
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))//分页方法
                ->toArray();
//            foreach ($list['data'] as $k => $v) {
//                $list['data'][$k]['status'] = config('user_lock')[$v['status']];
//            }
            //print_r($list['data']);
            //exit();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //会员众筹
    public function userCrowd()
    {
        if (request()->isPost()) {
            $key = input('post.key');
            if ($key != '') {
                $where['ul.user_id|users.username'] = $key;
            }
            $status3 = input('post.status3');
            if ($status3 != '') {
                $where['ul.status'] = $status3;
            }
            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['ul.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('user_crowd')->alias('ul')//设置数据库别名
            ->join('users', 'ul.user_id = users.user_id', 'left')//要关联的表名 关联条件 关联类型
            ->where($where)
                ->field('ul.*,FROM_UNIXTIME(ul.addtime) addtime,users.username')//指定一个表的某些字段查询
                ->order('ul.addtime desc')//用于对操作的结果排序。
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))//分页方法
                ->toArray();

            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //会员钱包
    public function userAccount()
    {
        if (request()->isPost()) {
            $key = input('post.key');
            if ($key != '') {
                $where['u.number|u.mobile|u.username|ul.user_id'] = $key;
            }
            $order = "ul.user_id desc";
            $field = input('post.field');
            $sort = input('post.sort');
            if ($field != '') {
                $order = "ul.$field $sort";
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $user_account = db('user_account');
            $list = $user_account->alias('ul')
                ->join('users u', 'ul.user_id=u.user_id')
                ->where($where)
                ->field('ul.*,u.username,u.mobile,u.number')
                ->order($order)
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            foreach ($list['data'] as $k => $v) {
                $list['data'][$k]['savings'] = number_format($v['savings'], 4, ".", "");
                $list['data'][$k]['lock'] = number_format($v['lock'], 4, ".", "");
                $list['data'][$k]['crowd'] = number_format($v['crowd'], 4, ".", "");
                $list['data'][$k]['crowd_total'] = number_format($v['crowd_total'], 4, ".", "");
                $list['data'][$k]['release_total'] = number_format($v['release_total'], 4, ".", "");
            }
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        $user_account = db('user_account')->field("ROUND(sum(`savings`),4) as savings_total,ROUND(sum(`lock`),4) as lock_total,ROUND(sum(`crowd`),4) as crowd_total")->select();
        $this->assign('user_account', $user_account[0]);
        return $this->fetch();
    }

    //会员身份认证
    public function idaudit()
    {
        if (request()->isPost()) {
            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['users.number|users.mobile|users.username|it.user_id|it.id_name|it.id_card'] = $key;
            }
            $status = input('post.status');
            if ($status != '') {
                $where['it.status'] = $status;
            }

            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['it.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }


            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('idaudit')->alias('it')
                ->join('users', 'it.user_id=users.user_id', 'left')
                ->field('users.pid,users.number,users.username,it.user_id,users.mobile,it.id_name,it.id_card,it.status,it.remark,it.auditor,it.addtime,FROM_UNIXTIME(it.audit_time) as audit_time')
                ->where($where)
                ->order('it.audit_time,it.addtime desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();

            foreach ($list['data'] as $k => $v) {
                if ($v['addtime'] != 0) {
                    $list['data'][$k]['addtime'] = date('Y-m-d H:i:s', $v['addtime']);
                } else {
                    $list['data'][$k]['addtime'] = null;
                }
                $pid = db('users')->alias('u')
                    ->join('idaudit id', 'u.user_id=id.user_id', 'left')
                    ->where('u.user_id', $v['pid'])
                    ->field('u.mobile,id.id_name')
                    ->find();
                $list['data'][$k]['p_mobile'] = $pid['mobile'];
                $list['data'][$k]['p_id_name'] = $pid['id_name'];
            }
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //会员身份审核
    public function idaudit_edit()
    {
        if (request()->isPost()) {
            $data = input('post.');
            $data['auditor'] = $_SESSION['session']['username'];
            $data['audit_time'] = time();


            Db::startTrans();
            try {
                $user = db('users')->where(array('user_id' => $data['user_id']))->field('user_level,pid')->find();
                if ($data['status'] == 1 && $user['pid'] != 10001) {

                    if ($user['user_level'] < 2) {
                        db('users')->where(array('user_id' => $data['user_id']))->update(['user_level' => 2]);
                    }
                    //查询用户及上级余额
                    $user_balance = Db('user_coin')->where(['user_id' => $data['user_id'], 'coin_id' => 2])->lock(true)->value('balance');
                    $p_balance = Db('user_coin')->where(['user_id' => $user['pid'], 'coin_id' => 2])->lock(true)->value('balance');

                    Db('user_coin')->where(['user_id' => $data['user_id'], 'coin_id' => 2])->update(['balance' => bcadd($user_balance, 3, 6)]);
                    Db('user_coin')->where(['user_id' => $user['pid'], 'coin_id' => 2])->update(['balance' => bcadd($p_balance, 0.5, 6)]);

                    Db('log_coin')->insert([
                        'user_id' => $data['user_id'],
                        'coin_id' => 2,
                        'num' => 3,
                        'amount' => $user_balance,
                        'balance' => bcadd($user_balance, 3, 6),
                        'addtime' => time(),
                        'status' => 1,
                        'union' => 'users',
                        'union_id' => $data['user_id'],
                        'type' => 99,
                        'remark' => '实名赠送',
                    ]);

                    Db('log_coin')->insert([
                        'user_id' => $user['pid'],
                        'coin_id' => 2,
                        'num' => 0.5,
                        'amount' => $p_balance,
                        'balance' => bcadd($p_balance, 0.5, 6),
                        'addtime' => time(),
                        'status' => 1,
                        'union' => 'users',
                        'union_id' => $data['user_id'],
                        'type' => 69,
                        'remark' => '推广获得',
                    ]);

                }

                db('idaudit')->update($data);

                //添加操作日志
                db('log_action')->insert(array('type' => 520, 'admin_name' => $_SESSION['session']['username'], 'object' => '身份认证' . ($data['status'] == 1 ? '通过' : '不通过') . 'ID:' . $data['user_id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'idaudit', 'union_id' => $data['user_id']));

                Db::commit();
                $result['msg'] = '状态已修改成功!';
                $result['url'] = url('idaudit');
                $result['code'] = 1;
                return $result;
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 0, 'msg' => '身份认证失败！', 'data' => $e->getMessage()];
                // var_dump('data');'die';
            }
        } else {
            $number = input('param.id');
            $where['number'] = $number;
            $map['user_id'] = db('users')->where($where)->value('user_id');
            $info = db('idaudit')->where($map)->field('user_id,id_name,id_card,status,remark,front_attach_id,back_attach_id,hand_attach_id')->find();
            $info['front_attach'] = config('OSS_GLOBAL')['oss_url'] . '/' . Db('attach')->where('attach_id', $info['front_attach_id'])->value('url');
            $info['back_attach'] = config('OSS_GLOBAL')['oss_url'] . '/' . Db('attach')->where('attach_id', $info['back_attach_id'])->value('url');
            $info['hand_attach'] = config('OSS_GLOBAL')['oss_url'] . '/' . Db('attach')->where('attach_id', $info['hand_attach_id'])->value('url');

            $this->assign('title', lang('edit') . "身份证审核");
            $this->assign('info', $info);
            return $this->fetch('idaudit_edit');
        }
    }

    /**
     * 批量审核
     * @return array
     */
    public function idaudit_all()
    {
        $ids = input('param.ids/a');
        $map['user_id'] = array('in', $ids);

        if (empty($ids)) {
            return ['code' => 0, 'msg' => '请勾选需要审核的订单！'];
        }
        $data['auditor'] = $_SESSION['session']['username'];
        $data['audit_time'] = time();

        Db::startTrans();
        try {
            $user = Db('users')->where($map)->field('user_level,pid,user_id')->select();

            foreach ($user as $k => $v) {

                $user_status = db('idaudit')->where(['user_id' => $v['user_id']])->value('status');

                if ($v['pid'] != 10001 && $user_status < 1) {
                    if ($v['user_level'] < 2) {
                        Db('users')->where(['user_id' => $v['user_id']])->update(['user_level' => 2]);
                    }
                    //查询用户及上级余额
                    $user_balance = Db('user_coin')->where(['user_id' => $v['user_id'], 'coin_id' => 2])->lock(true)->value('balance');
                    $p_balance = Db('user_coin')->where(['user_id' => $v['pid'], 'coin_id' => 2])->lock(true)->value('balance');

                    Db('user_coin')->where(['user_id' => $v['user_id'], 'coin_id' => 2])->update(['balance' => bcadd($user_balance, 3, 6)]);
                    Db('user_coin')->where(['user_id' => $v['pid'], 'coin_id' => 2])->update(['balance' => bcadd($p_balance, 0.5, 6)]);

                    Db('log_coin')->insert([
                        'user_id' => $v['user_id'],
                        'coin_id' => 2,
                        'num' => 3,
                        'amount' => $user_balance,
                        'balance' => bcadd($user_balance, 3, 6),
                        'addtime' => time(),
                        'status' => 1,
                        'union' => 'users',
                        'union_id' => $v['user_id'],
                        'type' => 99,
                        'remark' => '实名赠送',
                    ]);

                    Db('log_coin')->insert([
                        'user_id' => $v['pid'],
                        'coin_id' => 2,
                        'num' => 0.5,
                        'amount' => $p_balance,
                        'balance' => bcadd($p_balance, 0.5, 6),
                        'addtime' => time(),
                        'status' => 1,
                        'union' => 'users',
                        'union_id' => $v['user_id'],
                        'type' => 69,
                        'remark' => '推广获得',
                    ]);
                }
                Db('idaudit')->where(['user_id' => $v['user_id']])->update(['status' => 1]);

                //添加操作日志
                Db('log_action')->insert(array('type' => 292, 'admin_name' => $_SESSION['session']['username'], 'object' => '身份认证通过' . 'ID:' . $v['user_id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'idaudit', 'union_id' => $v['user_id'], 'type' => 520));

            }

            Db::commit();
            $result['msg'] = '状态已修改成功!';
            $result['url'] = url('idaudit');
            $result['code'] = 1;
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '身份认证失败！', 'data' => $e->getMessage()];
            // var_dump('data');'die';
        }

    }


    /**
     * 批量撤销
     * @return array
     */
    public function id_revoke()
    {
        $ids = input('param.ids/a');
        $map['user_id'] = array('in', $ids);

        if (empty($ids)) {
            return ['code' => 0, 'msg' => '请勾选需要审核的订单！'];
        }
        $data['auditor'] = $_SESSION['session']['username'];
        $data['audit_time'] = time();

        Db::startTrans();
        try {
            $user = db('idaudit')->where($map)->select();
            foreach ($user as $k => $v) {
                Db('idaudit')->where(['user_id' => $v['user_id']])->update(['status' => -1]);
                //添加操作日志
                Db('log_action')->insert(array('type' => 520, 'admin_name' => $_SESSION['session']['username'], 'object' => '身份认证不通过' . 'ID:' . $v['user_id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'idaudit', 'union_id' => $v['user_id']));

            }

            Db::commit();
            $result['msg'] = '状态已修改成功!';
            $result['url'] = url('idaudit');
            $result['code'] = 1;
            return $result;
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '身份认证失败！', 'data' => $e->getMessage()];
            // var_dump('data');'die';
        }

    }


    public function idaudit_lock()
    {
        if (request()->isPost()) {
        } else {
            $number = input('param.id');
            $where['number'] = $number;
            $map['user_id'] = db('users')->where($where)->value('user_id');
            $info = db('idaudit')->where($map)->field('user_id,id_name,id_card,status,remark,front_attach_id,back_attach_id,hand_attach_id')->find();
            $info['front_attach'] = config('OSS_GLOBAL')['oss_url'] . '/' . Db('attach')->where('attach_id', $info['front_attach_id'])->value('url');
            $info['back_attach'] = config('OSS_GLOBAL')['oss_url'] . '/' . Db('attach')->where('attach_id', $info['back_attach_id'])->value('url');
            $info['hand_attach'] = config('OSS_GLOBAL')['oss_url'] . '/' . Db('attach')->where('attach_id', $info['hand_attach_id'])->value('url');

            if ($info['status'] == 1) {
                $info['status'] = '已通过';
            } elseif ($info['status'] == -1) {
                $info['status'] = '审核不合格';
            } else {
                $info['status'] = '待审批';
            }

            $this->assign('title', lang('edit') . "身份证审核资料");
            $this->assign('info', $info);
            return $this->fetch('idaudit_lock');
        }
    }


    //会员能源
    public function user_addition()
    {
        if (request()->isPost()) {
            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['a.user_id|c.username'] = $key;
            }

            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['a.uptime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');

            $list = db('user_addition')->alias('a')
                ->join('users c', 'a.user_id=c.id')
                ->where($where)
                ->field('a.*,from_unixtime(a.uptime) as uptime,c.username')
                ->order('a.user_id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();

            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //通证充值提现表
    public function user_cash()
    {
        if (request()->isPost()) {
            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['users.number|ud.username|ud.wallet|ud.user_id|users.mobile'] = $key;
            }
            $status1 = input('post.status1');
            if ($status1 != '') {
                $where['ud.coin_id'] = $status1;
            }
            /*$status2 = input('post.status2');
            if ($status2 != '') {
                $where['ud.type'] = $status2;
            }*/
            $status3 = input('post.status3');
            if ($status3 != '') {
                $where['ud.status'] = $status3;
            }
            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['ud.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }

            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');

            $list = db('user_cash')->alias('ud')->join('coin c', 'c.coin_id=ud.coin_id', 'left')
                ->join('users', 'users.user_id=ud.user_id')
                ->join('idaudit id', 'ud.user_id=id.user_id', 'left')
                ->where($where)
                ->field('id.id_name,c.name,users.number,users.mobile,ud.id,ud.coin_id,ud.user_id,ud.username,ud.wallet,ud.num,ud.fee,(ud.num-ud.fee) as total,ud.remark,from_unixtime(ud.addtime) as addtime,from_unixtime(ud.operator_time) as operator_time,ud.operator,ud.transaction_id,if(ud.`status`=-1,\'2\',ud.`status`) as `status`,ud.type')
                ->order('`status` asc,ud.addtime desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            foreach ($list['data'] as $k => $v) {
                $list['data'][$k]['num'] = number_format($v['num'], 4, ".", "");
                $list['data'][$k]['fee'] = number_format($v['fee'], 4, ".", "");
                $list['data'][$k]['total'] = number_format($v['total'], 4, ".", "");
            }


            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        $coins = Db('coin')->field('coin_id,name')->select();
        $data['num'] = Db('user_cash')->where(['coin_id' => 2, 'status' => 1])->sum('num');
        $data['d_num'] = Db('user_cash')->where(['coin_id' => 2, 'status' => 0])->sum('num');
        $this->assign('coins', $coins);
        $this->assign('data', $data);
        return $this->fetch();
    }

    /**
     * 审核全部
     * @return array
     */
    public function cash_delall()
    {
        $ids = input('param.ids/a');
        $map['id'] = array('in', $ids);
        $map['status'] = 0;
        $map['coin_id'] = ['in', [1, 2, 3]];

        if (empty($ids)) {
            return ['code' => 0, 'msg' => '请勾选需要审核的订单！'];
        }
        if (count($ids) > 1) {
            return ['code' => 0, 'msg' => '只能审核一笔！'];
        }
        try {
            $cash_array = Db('user_cash')->where($map)->field('id,num,coin_id,wallet')->select();
            if (empty($cash_array)) {
                return ['code' => 0, 'msg' => '请重新选择要审核的订单！'];
            }
            Db::startTrans();
            foreach ($cash_array as $k) {
//          //判断区块钱包余额开始
                if ($k['coin_id'] == 2) {
                    //验证 USDT  钱包地址
                    $client = new \BtcClient(config('USDT')['host'], config('USDT')['port'], config('USDT')['user'], config('USDT')['password']);
                    $validate = $client->validateAddress($k['wallet']);
                    if (!$validate['isvalid']) {
                        Db::rollback();
                        return ['code' => 0, 'msg' => '钱包地址输入错误，你仔细核对确认该地址！'];
                    }
                    // 通过钱包转出
//                    $Balance = $client->omni_getbalance(config('USDT')['root'], 31);
//                    if (bccomp(bcsub($Balance['balance'], 0.0001, 8), $k['num'], 8) == -1) {
//                        Db::rollback();
//                        return ['code' => 0, 'msg' => '余额不足'];
//                    }
                } else {
                    Db::rollback();
                    return ['code' => 0, 'msg' => '请重新选择要审核的订单！'];
                }

                //开始执行转账 写入数据
                Db('user_cash')->where(['id' => $k['id']])->update(['status' => 1, 'operator_time' => time(), 'operator' => $_SESSION['session']['username']]);
                Db('log_cash')->insert(['user_cash_id' => $k['id'], 'audit_time' => time(), 'admin_name' => $_SESSION['session']['username']]);
                Db('log_coin')->where(['union' => 'user_cash', 'union_id' => $k['id']])->update(['status' => 1]);
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 23, 'union' => 'user_cash', 'union_id' => $k['id'], 'object' => "提现审核批量审核{$k['id']}", 'last_time' => time(), 'ip' => request()->ip(1)));

                if ($k['coin_id'] == 1) {


                } elseif ($k['coin_id'] == 2) {
                    $res = $this->USDT_out($k['num'], $k['wallet']);
//                var_dump($res);
                    if ($res['code'] == 0) {
                        Db::rollback();
                        return ['code' => 0, 'msg' => $res['msg']];
                    } else {
                        Db('user_cash')->where(['id' => $k['id']])->update(['is_trans' => 1, 'transaction_id' => $res['data']]);
                        Db::commit();
                        usleep(500000);
                    }
                }


            }
            Db::commit();
            return ['code' => 1, 'msg' => '审核成功！', json_encode($cash_array)];
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '审核失败2！' . $Balance, 'err_msg' => $e->getMessage()];
        }
    }

    //批量撤销
    public function revoke()
    {
        $ids = input('param.ids/a');
        $map['id'] = array('in', $ids);
        $map['status'] = 0;

        if (empty($ids)) {
            return ['code' => 0, 'msg' => '请勾选需要审核的订单！'];
        }

        $cash_array = db('user_cash')->where($map)->field('id,wallet,num,user_id,fee,coin_id')->select();

        if (empty($cash_array)) {
            return ['code' => 0, 'msg' => '请重新选择要审核的订单！'];
        }

        foreach ($cash_array as $k) {
            Db::startTrans();
            try {
                //改变订单状态
                db('user_cash')->where(['id' => $k['id']])->update(['status' => -1, 'operator_time' => time(), 'operator' => $_SESSION['session']['username']]);

                //增加用户余额
                $balance = db('user_coin')->where(['user_id' => $k['user_id'], 'coin_id' => $k['coin_id']])->lock(true)->value('balance');
                $num = bcadd($k['num'], $k['fee'], 8); //手续费加提现数量
                $balance_num = bcadd($balance, $num, 8);
                db('user_coin')->where(['user_id' => $k['user_id'], 'coin_id' => $k['coin_id']])->update(['balance' => $balance_num]);

                //添加日志
                $data = [
                    'user_id' => $k['user_id'],
                    'coin_id' => $k['coin_id'],
                    'num' => $num,
                    'fee' => 0,
                    'amount' => $balance,
                    'balance' => $balance_num,
                    'addtime' => time(),
                    'status' => 1,
                    'union' => 'user_cash',
                    'union_id' => $k['id'],
                    'type' => 58,
                    'remark' => '后台管理员:' . $_SESSION['session']['username'] . ',撤销订单' . $k['id'] . ',余额增加' . $num . ',(提现数量：' . $k['num'] . ',手续费：' . $k['fee'] . ')'
                ];
                db('log_coin')->insert($data);

                Db('log_cash')->insert(['user_cash_id' => $k['id'], 'audit_time' => time(), 'admin_name' => $_SESSION['session']['username']]);

                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 22, 'union' => 'user_cash', 'union_id' => $k['id'], 'object' => "提现审核批量撤销{$k['id']}", 'last_time' => time(), 'ip' => request()->ip(1)));
                Db::commit();
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 0, 'msg' => '审核失败！', 'err_msg' => $e->getMessage()];
            }
        }
        return ['code' => 1, 'msg' => '撤销成功！'];
    }

    //撤销提现申请
    public function cancel()
    {
        $map['user_id'] = input('user_id');
        $map['id'] = input('id');
        $map['status'] = 0;

        $cash = db('user_cash')->where($map)->field('id,wallet,num,user_id,fee,coin_id')->find();

        if (empty($cash)) {
            return ['code' => 0, 'msg' => '请重新选择要撤销的订单！'];
        }


        Db::startTrans();
        try {
            //改变订单状态
            db('user_cash')->where(['id' => $cash['id']])->update(['status' => -1, 'operator_time' => time(), 'operator' => $_SESSION['session']['username']]);

            //增加用户余额
            $balance = db('user_coin')->where(['user_id' => $cash['user_id'], 'coin_id' => $cash['coin_id']])->lock(true)->value('balance');
            $num = bcadd($cash['num'], $cash['fee'], 8); //手续费加提现数量
            $balance_num = bcadd($balance, $num, 8);
            db('user_coin')->where(['user_id' => $cash['user_id'], 'coin_id' => $cash['coin_id']])->update(['balance' => $balance_num]);

            //添加日志
            $data = [
                'user_id' => $cash['user_id'],
                'coin_id' => $cash['coin_id'],
                'num' => $num,
                'fee' => 0,
                'amount' => $balance,
                'balance' => $balance_num,
                'addtime' => time(),
                'status' => 1,
                'union' => 'user_cash',
                'union_id' => $cash['id'],
                'type' => 4,
                'remark' => '后台管理员:' . $_SESSION['session']['username'] . ',撤销订单' . $cash['id'] . ',余额增加' . $num . ',(提现数量：' . $cash['num'] . ',手续费：' . $cash['fee'] . ')'
            ];
            db('log_coin')->insert($data);

            Db('log_cash')->insert(['user_cash_id' => $cash['id'], 'audit_time' => time(), 'admin_name' => $_SESSION['session']['username']]);

            //添加操作日志
            db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 22, 'union' => 'user_cash', 'union_id' => $cash['id'], 'object' => "提现审核撤销{$cash['id']}", 'last_time' => time(), 'ip' => request()->ip(1)));
            Db::commit();
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '撤销失败！', 'err_msg' => $e->getMessage()];
        }

        return ['code' => 1, 'msg' => '撤销成功！'];
    }

    //重置状态
    public function user_draw_reset()
    {
        $draw_id = input('post.id');
        $status = db('user_cash')->where(array('id' => $draw_id))->value('status');//判断当前状态情况
        Db::startTrans();
        try {
            if ($status == 1) {
                $data['status'] = 0;
                $data['is_trans'] = 0;
                db('user_cash')->where(array('id' => $draw_id))->update($data);
                db('log_cash')->where(array('user_cash_id' => $draw_id))->delete();
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 21, 'union' => 'user_cash', 'union_id' => $draw_id, 'object' => "重置提现订单{$draw_id}", 'last_time' => time(), 'ip' => request()->ip(1)));

                $result['status'] = 0;
                $result['code'] = 1;
                $result['msg'] = '重置成功!';
                Db::commit();
                return $result;
            } else {
                return ['code' => 0, 'msg' => '操作失败!'];
            }
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!'];
        }
    }

    //用户资产
    public function user_coin()
    {
        if (request()->isPost()) {
            $key = input('post.key');
            if ($key != '') {
                $where['u.user_id|u.mobile|u.username'] = $key;
            }
            $status1 = input('post.status1');
            if ($status1 != '') {
                $where['ul.coin_id'] = $status1;
            }
            $sort = input('post.sort');
            if ($sort == '') {
                $sort = 'asc';
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('user_coin')->alias('ul')
                ->join('users u', 'u.user_id=ul.user_id')
                ->join('coin c', 'ul.coin_id=c.coin_id')
                ->join('idaudit id', 'ul.user_id=id.user_id', 'left')
                ->where($where)
                ->field('ul.*,u.username,u.mobile,c.name,id.id_name')
                ->order('ul.balance ' . $sort, 'ul.user_id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            $coins = Db('coin')->field('coin_id,name')->select();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1, 'coin' => $coins];
        }
        $data = Db('user_coin')->where(['coin_id' => ['in', [1, 2, 23]]])->field('coin_id,sum(balance) as balance')->group('coin_id')->select();

        $this->assign('data', $data);
        return $this->fetch();
    }

    //修改余额
    public function exchange($coin_id, $user_id, $num)
    {

        if ($coin_id == '' || $user_id == '' || $num == '') {
            return ['code' => 0, 'msg' => '数据异常!'];
        }

        Db::startTrans();
        try {

            $balance = Db('user_coin')->where(['user_id' => $user_id, 'coin_id' => $coin_id])->value('balance');

            $total = bcadd($balance, $num, 8);

            if ($total < 0) {
                return ['code' => 0, 'msg' => '余额不足!'];
            }
            $coin_name = Db('coin')->where('coin_id', '=', $coin_id)->value('name');
            if ($num < 0) {
                $type = 41;
                $num = -$num;
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 325, 'union' => 'users_coin', 'union_id' => $user_id, 'object' => '管理员操作' . $coin_name . '余额减少' . $num, 'last_time' => time(), 'ip' => request()->ip(1)));

                //添加充值表记录
                Db('log_coin_admin')->insertGetId([
                    'user_id' => $user_id,
                    'num' => -$num,
                    'amount' => $balance,
                    'balance' => $balance - $num,
                    'addtime' => time(),
                    'coin_id' => $coin_id,
                    'admin_name' => $_SESSION['session']['username'],
                    'status' => 1,
                    'remark' => $coin_name . '账户余额减少' . $num,
                ]);
            } else {
                $type = 81;
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 325, 'union' => 'users_coin', 'union_id' => $user_id, 'object' => '管理员操作' . $coin_name . '余额增加' . $num, 'last_time' => time(), 'ip' => request()->ip(1)));
                //添加充值表记录
                Db('log_coin_admin')->insertGetId([
                    'user_id' => $user_id,
                    'num' => $num,
                    'amount' => $balance,
                    'balance' => $balance + $num,
                    'addtime' => time(),
                    'coin_id' => $coin_id,
                    'admin_name' => $_SESSION['session']['username'],
                    'status' => 1,
                    'remark' => $coin_name . '账户余额增加' . $num,
                ]);
            }


            Db('user_coin')->where(['user_id' => $user_id, 'coin_id' => $coin_id])->update(['balance' => $total]);
            Db('log_coin')->insert(['user_id' => $user_id, 'coin_id' => $coin_id, 'num' => $num, 'amount' => $balance, 'balance' => $total, 'addtime' => time(), 'status' => 1, 'union' => 'admin_' . time(), 'union_id' => $_SESSION['session']['aid'], 'remark' => '后台管理员' . $_SESSION['session']['username'] . '操作', 'type' => $type]);
            //添加操作日志

            Db::commit();
            return ['code' => 1, 'msg' => '操作成功!'];
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '操作失败!', 'data' => $e->getMessage()];
        }
    }


//    public function sht_exchange()
//    {
//
//        $coin_id = input('coin_id');
//        $user_id = input('user_id');
//        try {
//
//            Db::startTrans();
//            $user_coin = Db::name('user_coin')->where(['user_id' => $user_id, 'coin_id' => $coin_id])->field('user_id,coin_id,balance')->lock(true)->find();
//            if ($user_coin['balance'] <= 0) {
//                Db::rollback();
//                return ['code' => 0, 'msg' => '要兑换的数字货币数量为0!'];
//            }
//
//
//            $user_account = Db::name('user_account')->where(['user_id' => $user_id])->field('user_id')->lock(true)->find();
//
//            $price = Db::name('price')->where(['date' => date('Ymd')])->value('price');
//            $coin_price = gt_sht_price();
//            $coin_name = 'SHT';
//            $expected_num = bcdiv(bcmul($coin_price, $user_coin['balance'], 8), $price, 8);
//
//            $log_id = Db('user_exchange')->insertGetId([
//                'user_id' => $user_id,
//                'coin_id' => $coin_id,
//                'coin_name' => $coin_name,
//                'first_coin_price' => $coin_price,
//                'final_coin_price' => $coin_price,
//                'first_coin_num' => $user_coin['balance'],
//                'final_coin_num' => $user_coin['balance'],
//                'first_mrc_price' => $price,
//                'final_mrc_price' => $price,
//                'first_mrc_num' => $expected_num,
//                'final_mrc_num' => $expected_num,
//                'fee' => 0,
//                'status' => 1,
//                'type' => 1,
//                'addtime' => time(),
//                'operator' => $_SESSION['session']['aid'],
//                'operator_time' => time(),
//                'remark' => '一键兑换MRC',
//            ]);
//
//            Db('log_coin')->insert([
//                'user_id' => $user_id,
//                'coin_id' => $coin_id,
//                'num' => $user_coin['balance'],
//                'amount' => $user_coin['balance'],
//                'balance' => 0,
//                'addtime' => time(),
//                'status' => 1,
//                'union' => 'user_coin',
//                'union_id' => $coin_id,
//                'type' => 12,
//                'remark' => '一键兑换MRC',
//            ]);
//
//            //添加log_temp表日志
//            $log_temp_id = db('log_coin')->insertGetId([
//                'user_id' => $user_id,
//                'coin_id' => $coin_id,
//                'num' => $expected_num,
//                'amount' => $user_account['temp'],
//                'balance' => bcadd($user_account['temp'], $expected_num, 8),
//                'addtime' => time(),
//                'union' => 'user_exchange',
//                'union_id' => $log_id,
//                'remark' => '一键兑换MRC',
//                'type' => '887',
//                'status' => '1',
//            ]);
//
//            //修改临时钱包 变动时间
//            Db('users')->where('user_id', $user_id)->setField('temp_time', time());
//
//            //更新user_account表数据
//            db('user_account')->where(['user_id' => $user_id])->update(['savings' => bcadd($user_account['savings'], $expected_num, 8)]);
//
//            //更新user_coin表数据
//            db('user_coin')->where(['user_id' => $user_id])->update(['balance' => 0]);
//
//            Db::commit();
//            return ['code' => 1, 'msg' => '兑换成功!'];
//
//        } catch (Exception $e) {
//
//            Db::rollback();
//            return ['code' => 0, 'msg' => '兑换失败，请稍候再试!', 'data' => $e->getMessage()];
//        }
//
//    }

    //会员临时钱包互转
    public function user_market()
    {
        if (request()->isPost()) {
            $key = input('post.key');
            if ($key != '') {
                $where['a.user_id|a.to_id|a.to_mobile|b.username|c.username'] = $key;
            }
            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['a.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('user_market')->alias('a')
                ->join('users b', 'b.user_id=a.user_id')
                ->join('users c', 'c.user_id=a.to_id')
                ->field('a.*,b.username,c.username to_username,from_unixtime(a.addtime) addtime')
                ->where($where)
                ->order('a.id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            foreach ($list['data'] as $k => $v) {
                $list['data'][$k]['num'] = number_format($v['num'], 4, ".", "");
                $list['data'][$k]['fee'] = number_format($v['fee'], 4, ".", "");
            }
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //钱包地址
    public function user_wallet()
    {
        if (request()->isPost()) {
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['uw.user_id'] = $key;
            }

            $list = db('user_wallet')->alias('uw')->join('coin c', 'c.coin_id = uw.coin_id')->join('users u', 'uw.user_id=u.user_id')
                ->field('uw.wallet_id,uw.user_id,uw.wallet,uw.status,uw.name,from_unixtime(uw.addtime) as addtime,c.name coin_name,u.username')
                ->where($where)
                ->order('uw.wallet_id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //会员关系
    public function userRela($pid = 0)
    {
        if (request()->isAjax()) {
            $where = ['r.pid' => $pid];
            $user = Db::name('UserRela')->alias('r')
                ->join('users u', 'r.user_id=u.user_id')
                ->join('idaudit id', 'u.user_id=id.user_id', 'left')
                ->field('u.user_id,u.username,u.mobile,FROM_UNIXTIME(u.addtime) addtime,r.pid, r.direct,r.team,id.id_name')
                ->where($where)->cache(3600)->select();
            return $user;
        } else {
            $where = [];
            $key = input('key');
            if ($key) {
                $where['u.user_id|u.mobile|u.username'] = $key;
            }
            $user = Db::name('UserRela')->alias('r')
                ->join('users u', 'r.user_id=u.user_id')
                ->join('idaudit id', 'u.user_id=id.user_id', 'left')
                ->field('u.user_id,u.username,u.mobile,u.addtime,r.direct,r.team,r.pid,id.id_name')
                ->where($where)->find();
            $this->assign('user', $user);
            $this->assign('key', $key);
            return $this->fetch();
        }
    }

    //会员节点
    public function node($id)
    {
        $info = db('user_rela')->where(['user_id' => $id])->field('user_id,node')->find();
        if (request()->isPost()) {
            $data = input('post.');
            Db::startTrans();
            try {
                if ($data['node'] != $info['node']) {
                    db('user_rela')->update($data);
                    db('log_action')->insertGetId(array('type' => 10, 'admin_name' => $_SESSION['session']['username'], 'object' => '会员节点状态' . ($data['node'] == 1 ? '开启' : '关闭') . 'ID:' . $id, 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_rela', 'union_id' => $id));
                    Db::commit();
                    return ['msg' => '修改成功!', 'url' => url('index'), 'code' => 1];
                } else {
                    return ['msg' => '未做修改 !', 'url' => url('index'), 'code' => 1];
                }
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 0, 'msg' => '操作失败!'];
            }
        } else {
            $this->assign('node', $info['node']);
            $this->assign('info', json_encode($info, true));
            $this->assign('title', lang('edit') . '节点');
            return $this->fetch();
        }
    }

    //锁仓VIP会员
    public function vip($id)
    {
        $info = db('user_rela')->where(['user_id' => $id])->field('user_id,vip,lft,rgt')->find();
        if (request()->isPost()) {
            $data = input('post.');
            Db::startTrans();
            try {
                if ($data['vip'] != $info['vip']) {
                    db('user_rela')->update($data);
                    db('log_action')->insertGetId(array('type' => 11, 'admin_name' => $_SESSION['session']['username'], 'object' => '锁仓VIP会员' . $info['vip'] . '-' . $data['vip'] . ' ID:' . $id, 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_rela', 'union_id' => $id));
                    Db::commit();
                    return ['msg' => '修改成功!', 'url' => url('index'), 'code' => 1];
                } else {
                    return ['msg' => '未做修改 !', 'url' => url('index'), 'code' => 1];
                }
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 0, 'msg' => '操作失败!'];
            }
        } else {
            $vip_level = db('lock')->field('lock_id,level_num')->order('lock_id')->select();
            $this->assign('vip_level', $vip_level);
            $this->assign('vip', $info['vip']);
            $this->assign('info', json_encode($info, true));
            $this->assign('title', lang('edit') . '锁仓VIP会员');
            return $this->fetch();
        }
    }

    //会员超级节点
    public function vip_node($id)
    {
        $info = db('user_rela')->where(['user_id' => $id])->field('user_id,vip_node,lft,rgt')->find();
        if (request()->isPost()) {
            $data = input('post.');
            Db::startTrans();
            try {
                if ($data['vip_node'] != $info['vip_node']) {
                    $data['vip_parent'] = '0';
                    if ($data['vip_node'] != 0) {
                        $vip_parent = db('user_rela')->where(['lft' => ['lt', $info['lft']], 'rgt' => ['gt', $info['rgt']], 'vip_node' => ['gt', 0]])->order('depth desc')->value('user_id');
                        if ($vip_parent) {
                            $data['vip_parent'] = $vip_parent;
                        }
                    }
                    db('user_rela')->update($data);
                    db('log_action')->insertGetId(array('type' => 11, 'admin_name' => $_SESSION['session']['username'], 'object' => '会员超级节点' . $info['vip_node'] . '-' . $data['vip_node'] . ' ID:' . $id, 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_rela', 'union_id' => $id));
                    Db::commit();
                    return ['msg' => '修改成功!', 'url' => url('index'), 'code' => 1];
                } else {
                    return ['msg' => '未做修改 !', 'url' => url('index'), 'code' => 1];
                }
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 0, 'msg' => '操作失败!'];
            }
        } else {
            $vip_level = db('vip_level')->where('status', '1')->field('vip_id,name,rate')->order('vip_id')->select();
            $this->assign('vip_level', $vip_level);
            $this->assign('vip_node', $info['vip_node']);
            $this->assign('info', json_encode($info, true));
            $this->assign('title', lang('edit') . '超级节点');
            return $this->fetch();
        }
    }

    //会员兑换申请
    public function user_exchange()
    {
        if (request()->isPost()) {
            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['ud.user_id|ud.id|u.username'] = $key;
            }
            $status1 = input('post.status1');
            if ($status1 != '') {
                $where['ud.coin_id'] = $status1;
            }
            $status2 = input('post.status2');
            if ($status2 != '') {
                $where['ud.type'] = $status2;
            }
            $status3 = input('post.status3');
            if ($status3 != '') {
                $where['ud.status'] = $status3;
            }
            $sldate = input('date', '') ? input('date', '') : '';
            if ($sldate != '') {
                $arr = explode(" - ", $sldate);
                if (count($arr) == 2) {
                    $arrdateone = strtotime($arr[0]);
                    $arrdatetwo = strtotime($arr[1]);
                    $where['ud.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
                }
            }

            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');

            $list = db('user_exchange')->alias('ud')
                ->join('users u', 'u.user_id=ud.user_id', 'left')
                ->join('users us', 'us.user_id=ud.operator', 'left')
                ->where($where)
                ->field('u.username,us.username operator,ud.id,ud.coin_name,ud.first_coin_price,ud.final_coin_price,ud.first_coin_num,ud.final_coin_num,ud.first_mrc_price,ud.final_mrc_price,ud.first_mrc_num,ud.final_mrc_num,ud.coin_id,ud.user_id,from_unixtime(ud.addtime) as addtime,from_unixtime(ud.operator_time) as operator_time,ud.status,ud.type')
                ->order('ud.operator_time asc,ud.addtime asc,`status` asc,ud.id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            foreach ($list['data'] as $k => $v) {
                $list['data'][$k]['first_coin_price'] = number_format($v['first_coin_price'], 4, ".", "");
                $list['data'][$k]['final_coin_price'] = number_format($v['final_coin_price'], 4, ".", "");
                $list['data'][$k]['first_coin_num'] = number_format($v['first_coin_num'], 4, ".", "");
                $list['data'][$k]['final_coin_num'] = number_format($v['final_coin_num'], 4, ".", "");
                $list['data'][$k]['first_mrc_price'] = number_format($v['first_mrc_price'], 4, ".", "");
                $list['data'][$k]['final_mrc_price'] = number_format($v['final_mrc_price'], 4, ".", "");
                $list['data'][$k]['first_mrc_num'] = number_format($v['first_mrc_num'], 4, ".", "");
                $list['data'][$k]['final_mrc_num'] = number_format($v['final_mrc_num'], 4, ".", "");
            }
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        //token价格
        $coin_data['USDT'] = '1.00 $';
        $coin_data['ETH'] = get_coin_price('ETH') . ' USDT';
        $coin_data['BTC'] = get_coin_price('BTC') . ' USDT';
        $coin_data['SHT'] = get_coin_price('SHT') . ' USDT';
        $coin_data['MRC'] = number_format(db('price')->where('date', date('Ymd', time()))->value('price'), 4) . ' USDT';

        $queues['real_queues'] = Db('user_exchange')->where(['status' => 0, 'type' => 1])->sum('first_mrc_num');
        $queues['change_queues'] = intval(Db::name('config')->where(['name' => 'exchange_mrc_amount'])->value('value'));
        $queues['show_queues'] = $queues['real_queues'] + $queues['change_queues'];

        $this->assign('coin_data', $coin_data);
        $this->assign('queues', $queues);

        $coins = Db('coin')->field('coin_id,name')->select();
        $this->assign('coins', $coins);
        return $this->fetch();
    }

    //修改exchange_mrc_amount
    public function change_queues()
    {
        $data = input('post.');
        db('config')->where('name', 'exchange_mrc_amount')->update(['value' => $data['num']]);
        return ['code' => 1, 'msg' => '操作成功'];
    }

    //审核兑换
    public function audit_exchange($id)
    {
        $info = db('user_exchange')->where(['id' => $id])->find();
        if (request()->isPost()) {
            $data = input('post.');
            if ($data['status'] != $info['status']) {
                $data['operator_time'] = time();
                $data['operator'] = $_SESSION['session']['aid'];

                Db::startTrans();
                try {
                    if ($info['status'] != 0) {
                        return ['code' => 0, 'msg' => '只能对待审核的数据进行操作'];
                    }

                    //MRC兑换通证
                    if ($info['type'] == 2) {
                        $final_num = bcadd($info['final_mrc_num'], $info['fee'], 8);//转出金额和手续费的总和
                        //审核通过
                        if ($data['status'] == '1') {
                            //从火币获取token价格
                            $coin = Db::name('coin')->where(['status' => 1, 'coin_id' => $info['coin_id']])->field('coin_id, name')->find();
                            if (!$coin) return ['code' => 0, 'msg' => '通证种类错误'];
                            $data['final_coin_price'] = get_coin_price($coin['name']);

                            $data['final_mrc_price'] = Db('price')->where(['date' => date('Ymd')])->value('price');//审核时mrc价格
                            if (!$data['final_coin_price'] || !$data['final_mrc_price']) {
                                return ['code' => 0, 'msg' => '获取价格失败'];
                            }

                            $data['final_coin_num'] = bcdiv(bcmul($info['final_mrc_num'], $data['final_mrc_price'], 8), $data['final_coin_price'], 8);//审核兑换的通证数量
                            $data['remark'] = '审核已通过,消耗' . $info['final_mrc_num'] . 'MRC,最终兑换' . $data['final_coin_num'] . $info['coin_name'] . ',手续费' . $info['fee'] . 'MRC,共消耗' . $final_num . 'MRC';
                            //更改log_activity表status
                            db('log_activity')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 660])->update(['status' => $data['status']]);
                            //查询操作之前资产
                            $balance = db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->lock(true)->find();
                            //如果user_coin表没有该记录，则添加
                            if (!$balance) {
                                db('user_coin')->insert(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']]);
                                $amount = 0;//操作前通证数量
                            } else {
                                $amount = $balance['balance'];
                            }
                            //添加log_coin表日志
                            $log_coin_id = db('log_coin')->insertGetId([
                                'user_id' => $info['user_id'],
                                'coin_id' => $info['coin_id'],
                                'num' => $data['final_coin_num'],
                                'amount' => $amount,
                                'balance' => bcadd($amount, $data['final_coin_num'], 8),//操作后通证数量
                                'addtime' => time(),
                                'union' => 'user_exchange',
                                'union_id' => $info['id'],
                                'remark' => 'MRC兑换通证',
                                'type' => '2',
                                'status' => '1',
                            ]);
                            //更新user_coin表数据
                            db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->update(['balance' => bcadd($amount, $data['final_coin_num'], 8)]);
                        } elseif ($data['status'] == '-1') {
                            $data['remark'] = '审核未通过,共退还' . $final_num . 'MRC';
                            //更改log_activity表status
                            db('log_activity')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 660])->update(['status' => $data['status']]);
                            //log_activity表添加一条退还的日志
                            $balance = Db('user_account')->where(['user_id' => $info['user_id']])->lock(true)->field('active')->find();
                            db('log_activity')->insert([
                                'user_id' => $info['user_id'],
                                'num' => $final_num,
                                'amount' => $balance['active'],
                                'balance' => bcadd($balance['active'], $final_num, 8),
                                'addtime' => time(),
                                'status' => '1',
                                'remark' => '审核未通过,共退还' . $final_num . 'MRC',
                                'type' => '669',
                                'union' => 'user_exchange',
                                'union_id' => $info['id'],
                            ]);
                            //更新user_account表数据
                            db('user_account')->where('user_id', $info['user_id'])->update(['active' => bcadd($balance['active'], $final_num, 8)]);
                        }
                        db('log_action')->insertGetId(array('type' => 31, 'admin_name' => $_SESSION['session']['username'], 'object' => '审核MRC兑换通证' . ($data['status'] == 1 ? '通过' : '不通过') . 'ID:' . $id, 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_exchange', 'union_id' => $id));
                    }

                    //通证兑换MRC
                    if ($info['type'] == 1) {
                        //添加操作日志
                        if ($data['status'] == '1') {
                            //从火币获取token价格
                            $coin = Db::name('coin')->where(['status' => 1, 'coin_id' => $info['coin_id']])->field('coin_id, name')->find();
                            if (!$coin) return ['code' => 0, 'msg' => '通证种类错误'];
                            $data['final_coin_price'] = get_coin_price($coin['name']);

                            $data['final_mrc_price'] = Db('price')->where(['date' => date('Ymd')])->value('price');//审核时mrc价格
                            if (!$data['final_coin_price'] || !$data['final_mrc_price']) {
                                return ['code' => 0, 'msg' => '获取价格失败'];
                            }

                            if ($info['coin_id'] == 1 && $info['addtime'] >= strtotime('2018-08-20 11:00:00') && $info['addtime'] <= strtotime('2018-08-21 00:00:00'))
                                $data['final_mrc_price'] = 0.15 * 0.8;

                            $data['final_mrc_num'] = bcdiv(bcmul($info['first_coin_num'], $data['final_coin_price'], 8), $data['final_mrc_price'], 8);//审核兑换的MRC数量
                            $data['remark'] = '审核已通过,消耗' . $info['first_coin_num'] . $info['coin_name'] . ',最终兑换' . $data['final_mrc_num'] . 'MRC';
                            //更改log_coin表status
                            db('log_coin')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 12])->update(['status' => $data['status']]);
                            //查询操作之前资产
                            $balance = Db('user_account')->where(['user_id' => $info['user_id']])->lock(true)->field('temp')->find();
                            //添加log_temp表日志
                            $log_temp_id = db('log_temp')->insertGetId([
                                'user_id' => $info['user_id'],
                                'num' => $data['final_mrc_num'],
                                'amount' => $balance['temp'],
                                'balance' => bcadd($balance['temp'], $data['final_mrc_num'], 8),
                                'addtime' => time(),
                                'union' => 'user_exchange',
                                'union_id' => $info['id'],
                                'remark' => '通证兑换MRC',
                                'type' => '887',
                                'status' => '1',
                            ]);

                            //修改临时钱包 变动时间
                            Db('users')->where('user_id', $info['user_id'])->setField('temp_time', time());

                            //更新user_account表数据
                            db('user_account')->where(['user_id' => $info['user_id']])->update(['temp' => bcadd($balance['temp'], $data['final_mrc_num'], 8)]);
                        } elseif ($data['status'] == '-1') {
                            $data['remark'] = '审核未通过,共退还' . $info['first_coin_num'] . $info['coin_name'];
                            //更改log_coin表status
                            db('log_coin')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 12])->update(['status' => $data['status']]);
                            //log_coin表添加一条退还的日志
                            $balance = db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->lock(true)->find();
                            db('log_coin')->insert([
                                'user_id' => $info['user_id'],
                                'coin_id' => $info['coin_id'],
                                'num' => $info['first_coin_num'],
                                'amount' => $balance['balance'],
                                'balance' => bcadd($balance['balance'], $info['first_coin_num'], 8),
                                'addtime' => time(),
                                'status' => '1',
                                'remark' => '审核未通过,共退还' . $info['first_coin_num'] . $info['coin_name'],
                                'type' => '3',
                                'union' => 'user_exchange',
                                'union_id' => $info['id'],
                            ]);
                            //更新user_coin表数据
                            db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->update(['balance' => bcadd($balance['balance'], $info['first_coin_num'], 8)]);
                        }
                        db('log_action')->insertGetId(array('type' => 32, 'admin_name' => $_SESSION['session']['username'], 'object' => '审核通证兑换MRC' . ($data['status'] == 1 ? '通过' : '不通过') . 'ID:' . $id, 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_exchange', 'union_id' => $id));
                    }

                    //修改user_exchange表数据
                    db('user_exchange')->update($data);
                    //log_exchange添加一条数据
                    db('log_exchange')->insert([
                        'user_exchange_id' => $info['id'],
                        'admin_name' => $_SESSION['session']['username'],
                        'audit_time' => time(),
                        'remark' => $data['remark'],
                    ]);

                    Db::commit();
                    return ['msg' => '操作成功!', 'url' => url('user_exchange'), 'code' => 1];
                } catch (Exception $e) {
                    Log::error($e->getMessage());
                    Db::rollback();
                    return ['code' => 0, 'msg' => '操作失败!', $e->getMessage()];
                }
            }
            return ['msg' => '未作修改!', 'url' => url('user_exchange'), 'code' => 1];
        } else {
            $status = db('user_exchange')->where(['id' => $id])->value('status');
            $this->assign('status', $status);
            $this->assign('info', json_encode($info, true));
            $this->assign('title', '审核');
            return $this->fetch();
        }
    }

    //批量通过
    public function allow_all()
    {
        $ids = input('param.ids/a');
        $map['id'] = array('in', $ids);
        $map['status'] = 0;

        //$map['coin_id'] = ['in', [1, 4, 16, 3, 10]];
        if (empty($ids)) {
            return ['code' => 0, 'msg' => '请勾选需要审核的订单！'];
        }
        try {
            $cash_array = Db('user_exchange')->where($map)->select();
            if (empty($cash_array)) {
                return ['code' => 0, 'msg' => '请重新选择要审核的订单！'];
            }
            $i = 0;
            foreach ($cash_array as $k => $info) {
                $data['operator_time'] = time();
                $data['operator'] = $_SESSION['session']['aid'];
                $data['status'] = '1';
                //从火币获取token价格
                $coin = Db::name('coin')->where(['status' => 1, 'coin_id' => $info['coin_id']])->field('coin_id, name')->find();
                if (!$coin) return ['code' => 0, 'msg' => '通证种类错误'];
                $data['final_coin_price'] = get_coin_price($coin['name']);

                $data['final_mrc_price'] = Db('price')->where(['date' => date('Ymd')])->value('price');//审核时mrc价格
                if ($info['coin_id'] == 1 && $info['addtime'] >= strtotime('2018-08-20 11:00:00') && $info['addtime'] <= strtotime('2018-08-21 00:00:00'))
                    $data['final_mrc_price'] = 0.15 * 0.8;

                if (!$data['final_coin_price'] || !$data['final_mrc_price']) {
                    return ['code' => 0, 'msg' => '获取价格失败'];
                }
                Db::startTrans();

                //MRC兑换通证
                if ($info['type'] == 2) {
                    $final_num = bcadd($info['final_mrc_num'], $info['fee'], 8);//转出金额和手续费的总和
                    $data['final_coin_num'] = bcdiv(bcmul($info['final_mrc_num'], $data['final_mrc_price'], 8), $data['final_coin_price'], 8);//审核兑换的通证数量
                    $data['remark'] = '审核已通过,消耗' . $info['final_mrc_num'] . 'MRC,最终兑换' . $data['final_coin_num'] . $info['coin_name'] . ',手续费' . $info['fee'] . 'MRC,共消耗' . $final_num . 'MRC';
                    //更改log_activity表status
                    db('log_activity')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 660])->update(['status' => 1]);
                    //查询操作之前资产
                    $balance = db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->lock(true)->find();
                    //如果user_coin表没有该记录，则添加
                    if (!$balance) {
                        db('user_coin')->insert(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']]);
                        $amount = 0;//操作前通证数量
                    } else {
                        $amount = $balance['balance'];
                    }
                    //添加log_coin表日志
                    $log_coin_id = db('log_coin')->insertGetId([
                        'user_id' => $info['user_id'],
                        'coin_id' => $info['coin_id'],
                        'num' => $data['final_coin_num'],
                        'amount' => $amount,
                        'balance' => bcadd($amount, $data['final_coin_num'], 8),//操作后通证数量
                        'addtime' => time(),
                        'union' => 'user_exchange',
                        'union_id' => $info['id'],
                        'remark' => 'MRC兑换通证',
                        'type' => '2',
                        'status' => '1',
                    ]);
                    //更新user_coin表数据
                    db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->update(['balance' => bcadd($amount, $data['final_coin_num'], 8)]);
                    db('log_action')->insertGetId(array('type' => 31, 'admin_name' => $_SESSION['session']['username'], 'object' => '审核MRC兑换通证通过' . 'ID:' . $info['id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_exchange', 'union_id' => $info['id']));
                }

                //通证兑换MRC
                if ($info['type'] == 1) {
                    //添加操作日志
                    $data['final_mrc_num'] = bcdiv(bcmul($info['first_coin_num'], $data['final_coin_price'], 8), $data['final_mrc_price'], 8);//审核兑换的MRC数量
                    $data['remark'] = '审核已通过,消耗' . $info['first_coin_num'] . $info['coin_name'] . ',最终兑换' . $data['final_mrc_num'] . 'MRC';
                    //更改log_coin表status
                    db('log_coin')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 12])->update(['status' => 1]);
                    //查询操作之前资产
                    $balance = Db('user_account')->where(['user_id' => $info['user_id']])->lock(true)->field('temp')->find();
                    //添加log_temp表日志
                    $log_temp_id = db('log_temp')->insertGetId([
                        'user_id' => $info['user_id'],
                        'num' => $data['final_mrc_num'],
                        'amount' => $balance['temp'],
                        'balance' => bcadd($balance['temp'], $data['final_mrc_num'], 8),
                        'addtime' => time(),
                        'union' => 'user_exchange',
                        'union_id' => $info['id'],
                        'remark' => '通证兑换MRC',
                        'type' => '887',
                        'status' => '1',
                    ]);

                    //修改临时钱包 变动时间
                    Db('users')->where('user_id', $info['user_id'])->setField('temp_time', time());

                    //更新user_account表数据
                    db('user_account')->where(['user_id' => $info['user_id']])->update(['temp' => bcadd($balance['temp'], $data['final_mrc_num'], 8)]);
                    db('log_action')->insertGetId(array('type' => 32, 'admin_name' => $_SESSION['session']['username'], 'object' => '审核通证兑换MRC通过' . 'ID:' . $info['id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_exchange', 'union_id' => $info['id']));
                }

                //修改user_exchange表数据
                db('user_exchange')->where('id', $info['id'])->update($data);
                //log_exchange添加一条数据
                db('log_exchange')->insert([
                    'user_exchange_id' => $info['id'],
                    'admin_name' => $_SESSION['session']['username'],
                    'audit_time' => time(),
                    'remark' => $data['remark'],
                ]);
                Db::commit();
                $i++;
            }
            return ['code' => 1, 'msg' => '审核成功' . $i . '条！'];
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '审核失败！', ['err_msg' => $e->getMessage()]];
        }
    }

    //批量拒绝
    public function deny_all()
    {
        $ids = input('param.ids/a');
        $map['id'] = array('in', $ids);
        $map['status'] = 0;
        $map['coin_id'] = ['in', [2, 3]];

        if (empty($ids)) {
            return ['code' => 0, 'msg' => '请勾选需要审核的订单！'];
        }
        try {
            $cash_array = Db('user_exchange')->where($map)->select();
            if (empty($cash_array)) {
                return ['code' => 0, 'msg' => '请重新选择要审核的订单！'];
            }
            $i = 0;
            foreach ($cash_array as $k => $info) {
                $data['operator_time'] = time();
                $data['operator'] = $_SESSION['session']['aid'];
                $data['status'] = '-1';

                Db::startTrans();
                //MRC兑换通证
                if ($info['type'] == 2) {
                    $final_num = bcadd($info['final_mrc_num'], $info['fee'], 8);//转出金额和手续费的总和
                    $data['remark'] = '审核未通过,共退还' . $final_num . 'MRC';
                    //更改log_activity表status
                    db('log_activity')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 660])->update(['status' => $data['status']]);
                    //log_activity表添加一条退还的日志
                    $balance = Db('user_account')->where(['user_id' => $info['user_id']])->lock(true)->field('active')->find();
                    db('log_activity')->insert([
                        'user_id' => $info['user_id'],
                        'num' => $final_num,
                        'amount' => $balance['active'],
                        'balance' => bcadd($balance['active'], $final_num, 8),
                        'addtime' => time(),
                        'status' => '1',
                        'remark' => '审核未通过,共退还' . $final_num . 'MRC',
                        'type' => '669',
                        'union' => 'user_exchange',
                        'union_id' => $info['id'],
                    ]);
                    //更新user_account表数据
                    db('user_account')->where('user_id', $info['user_id'])->update(['active' => bcadd($balance['active'], $final_num, 8)]);
                    db('log_action')->insertGetId(array('type' => 31, 'admin_name' => $_SESSION['session']['username'], 'object' => '审核MRC兑换通证不通过' . 'ID:' . $info['id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_exchange', 'union_id' => $info['id']));
                }

                //通证兑换MRC
                if ($info['type'] == 1) {
                    $data['remark'] = '审核未通过,共退还' . $info['first_coin_num'] . $info['coin_name'];
                    //更改log_coin表status
                    db('log_coin')->where(['union' => 'user_exchange', 'union_id' => $info['id'], 'type' => 12])->update(['status' => $data['status']]);
                    //log_coin表添加一条退还的日志
                    $balance = db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->lock(true)->find();
                    db('log_coin')->insert([
                        'user_id' => $info['user_id'],
                        'coin_id' => $info['coin_id'],
                        'num' => $info['first_coin_num'],
                        'amount' => $balance['balance'],
                        'balance' => bcadd($balance['balance'], $info['first_coin_num'], 8),
                        'addtime' => time(),
                        'status' => '1',
                        'remark' => '审核未通过,共退还' . $info['first_coin_num'] . $info['coin_name'],
                        'type' => '3',
                        'union' => 'user_exchange',
                        'union_id' => $info['id'],
                    ]);
                    //更新user_coin表数据
                    db('user_coin')->where(['user_id' => $info['user_id'], 'coin_id' => $info['coin_id']])->update(['balance' => bcadd($balance['balance'], $info['first_coin_num'], 8)]);
                    db('log_action')->insertGetId(array('type' => 32, 'admin_name' => $_SESSION['session']['username'], 'object' => '审核通证兑换MRC不通过' . 'ID:' . $info['id'], 'last_time' => time(), 'ip' => request()->ip(1), 'union' => 'user_exchange', 'union_id' => $info['id']));
                }

                //修改user_exchange表数据
                db('user_exchange')->where('id', $info['id'])->update($data);
                //log_exchange添加一条数据
                db('log_exchange')->insert([
                    'user_exchange_id' => $info['id'],
                    'admin_name' => $_SESSION['session']['username'],
                    'audit_time' => time(),
                    'remark' => $data['remark'],
                ]);
                Db::commit();
                $i++;
            }
            return ['code' => 1, 'msg' => '审核成功' . $i . '条！'];
        } catch (Exception $e) {
            Log::error($e->getMessage());
            Db::rollback();
            return ['code' => 0, 'msg' => '审核失败！', ['err_msg' => $e->getMessage()]];
        }
    }

    //充值列表
    public function user_recharge()
    {

        $key = input('post.key');
        if ($key != '') {
            $where['b.username|a.user_id|a.admin_name'] = $key;
        }
        $sldate = input('date', '') ? input('date', '') : '';
        if ($sldate != '') {
            $arr = explode(" - ", $sldate);
            if (count($arr) == 2) {
                $arrdateone = strtotime($arr[0]);
                $arrdatetwo = strtotime($arr[1]);
                $where['a.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
            }
        }

        if (request()->isPost()) {
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $list = db('log_coin_admin')->alias('a')
                ->join('users b', 'a.user_id=b.user_id')
                ->join('idaudit id', 'a.user_id=id.user_id', 'left')
                ->where($where)
                ->field('a.*,from_unixtime(a.addtime) addtime,b.username,b.mobile,id.id_name')
                ->order('id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //充值扣除
    public function recharge()
    {
        $user_id = input('id');
        if (request()->isPost()) {
            Db::startTrans();
            try {
                $data = input('post.');
                $user_id = input('id');
                if (floatval($data['num']) >= 0) {
                    $type = '10';
                    $num = floatval($data['num']);
                    $remark = '后台充值' . $num . 'AWT';
                } else {
                    $type = '20';
                    $num = abs(floatval($data['num']));
                    $remark = '后台扣除' . $num . 'AWT';
                }

                //log_savings表添加记录
                $balance = Db('user_account')->where(['user_id' => $user_id])->lock(true)->value('savings');
                $new_balance = bcadd($balance, floatval($data['num']), 8);
                $log_savings_id = Db('log_savings')->insertGetId([
                    'user_id' => $user_id,
                    'num' => $num,
                    'amount' => $balance,
                    'balance' => $new_balance,
                    'status' => 1,
                    'addtime' => time(),
                    'type' => $type,
                    'remark' => $remark,
                    //'admin_name' => $_SESSION['session']['username'],
                ]);

                //更新user_account表
                Db('user_account')->where('user_id', $user_id)->update(['savings' => $new_balance]);
//
                //添加操作日志
                if ($type == 10) {
                    db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 41, 'union' => 'user_account', 'union_id' => $user_id, 'object' => $remark, 'last_time' => time(), 'ip' => request()->ip(1)));
                } else {
                    db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 42, 'union' => 'user_account', 'union_id' => $user_id, 'object' => $remark, 'last_time' => time(), 'ip' => request()->ip(1)));
                }
                Db::commit();
                $this->up_node($user_id);
                $result['msg'] = '操作成功!';
                $result['url'] = url('userAccount');
                $result['code'] = 1;
                return $result;
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 1, 'msg' => '操作失败！', 'data' => $e->getMessage()];
            }
        } else {
            $user = db('users')->where('user_id', $user_id)->field('user_id,username')->find();
            $this->assign('title', '充值/扣除');
            $this->assign('info', 'null');
            $this->assign('user', $user);
            return $this->fetch();
        }
    }

    //导出提现记录
    public function export()
    {
        $where = [];
        $key = input('key');
        if ($key != '') {
            $where['ud.user_id|ud.username'] = $key;
        }
        $status1 = input('status1');
        if ($status1 != '') {
            $where['ud.coin_id'] = $status1;
        }
        /*$status2 = input('status2');
        if ($status2 != '') {
            $where['ud.type'] = $status2;
        }*/
        $status3 = input('status3');
        if ($status3 != '') {
            $where['ud.status'] = $status3;
        }
        $sldate = input('date', '') ? input('date', '') : '';
        if ($sldate != '') {
            $arr = explode(" - ", $sldate);
            if (count($arr) == 2) {
                $arrdateone = strtotime($arr[0]);
                $arrdatetwo = strtotime($arr[1]);
                $where['ud.addtime'] = array(array('egt', $arrdateone), array('elt', $arrdatetwo), 'AND');
            }
        }


        $data = db('user_cash')->alias('ud')
            ->join('users', 'ud.user_id=users.user_id')
            ->join('coin c', 'c.coin_id=ud.coin_id', 'left')
            ->where($where)
            ->field('c.name,users.number,ud.id,ud.user_id,ud.username,ud.num,ud.wallet,ud.fee,ud.operator,ud.addtime,ud.operator_time,if(ud.`status`=-1,\'2\',ud.`status`) as `status`,ud.type')
            ->order('`status` asc,ud.addtime asc,ud.id desc')
            ->select();

        Vendor('phpexcel.PHPExcel');//调用类库,路径是基于vendor文件夹的
        Vendor('phpexcel.PHPExcel.Worksheet.Drawing');
        Vendor('phpexcel.PHPExcel.Writer.Excel2007');
        $objExcel = new \PHPExcel();
        $objWriter = \PHPExcel_IOFactory::createWriter($objExcel, 'Excel2007');

        $objActSheet = $objExcel->getActiveSheet();
        $letter = explode(',', "A,B,C,D,E,F,G,H,I,J,K,L,M");
        $arrHeader = array('编号', '会员id', '会员名', '通证名称', '类型', '提现钱包地址', '提现数量', '手续费', '申请时间', '审批时间', '审批人', '状态');;
        //填充表头信息
        $lenth = count($arrHeader);
        for ($i = 0; $i < $lenth; $i++) {
            $objActSheet->setCellValue("$letter[$i]1", "$arrHeader[$i]");
        };
        //填充表格信息
        foreach ($data as $k => $v) {
            if ($v['type'] == 1) {
                $v['type'] = '提现';
            }
            if ($v['status'] == 0) {
                $v['status'] = '申请中';
            } elseif ($v['status'] == 1) {
                $v['status'] = '已通过';
            } else {
                $v['status'] = '已撤销';
            }
            if ($v['addtime'] != 0) {
                $v['addtime'] = date('Y-m-d H:i:s', $v['addtime']);
            }
            if ($v['operator_time'] != 0) {
                $v['operator_time'] = date('Y-m-d H:i:s', $v['operator_time']);
            }

            $k += 2;
            $objActSheet->setCellValue('A' . $k, $v['id']);
            $objActSheet->setCellValue('B' . $k, $v['number']);
            $objActSheet->setCellValue('C' . $k, $v['username']);
            $objActSheet->setCellValue('D' . $k, $v['name']);
            $objActSheet->setCellValue('E' . $k, $v['type']);
            $objActSheet->setCellValue('F' . $k, $v['wallet']);
            $objActSheet->setCellValue('G' . $k, $v['num']);
            $objActSheet->setCellValue('H' . $k, $v['fee']);
            $objActSheet->setCellValue('I' . $k, $v['addtime']);
            $objActSheet->setCellValue('J' . $k, $v['operator_time']);
            $objActSheet->setCellValue('K' . $k, $v['operator']);
            $objActSheet->setCellValue('L' . $k, $v['status']);

            // 表格高度
            $objActSheet->getRowDimension($k)->setRowHeight(20);
        }

        //设置表格的宽度
        $objActSheet->getColumnDimension('A')->setWidth('15');
        $objActSheet->getColumnDimension('B')->setWidth('15');
        $objActSheet->getColumnDimension('C')->setWidth('15');
        $objActSheet->getColumnDimension('D')->setWidth('15');
        $objActSheet->getColumnDimension('E')->setWidth('15');
        $objActSheet->getColumnDimension('F')->setWidth('40');
        $objActSheet->getColumnDimension('G')->setWidth('15');
        $objActSheet->getColumnDimension('H')->setWidth('15');
        $objActSheet->getColumnDimension('I')->setWidth('20');
        $objActSheet->getColumnDimension('J')->setWidth('20');
        $objActSheet->getColumnDimension('K')->setWidth('20');
        $objActSheet->getColumnDimension('L')->setWidth('15');
        $objActSheet->getColumnDimension('M')->setWidth('15');

        $outfile = "提现列表" . date("YmdHis") . ".xls";
        ob_end_clean();
        header("Content-Type: application/force-download");
        header("Content-Type: application/octet-stream");
        header("Content-Type: application/download");
        header('Content-Disposition:inline;filename="' . $outfile . '"');
        header("Content-Transfer-Encoding: binary");
        header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
        header("Pragma: no-cache");
        $objWriter->save('php://output');
    }

    //会员众筹
    public function user_crowd()
    {
        if (request()->isPost()) {
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $where = [];
            $key = input('post.key');
            if ($key != '') {
                $where['u.number|u.username|ua.user_id'] = $key;
            }

            $list = db('user_account')->alias('ua')
                ->join('users u', 'u.user_id=ua.user_id')
                ->where($where)
                ->order('ua.user_id desc')
                ->field('ua.user_id,ua.crowd,ua.crowd_total,ua.release_total,u.username,u.number')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //众筹列表
    public function user_crowd_list()
    {
        if (request()->isPost()) {
            $page = input('page') ? input('page') : 1;
            $pageSize = input('limit') ? input('limit') : config('pageSize');
            $where['uc.user_id'] = input('id');
            $list = db('user_crowd')->alias('uc')
                ->join('users u', 'u.user_id=uc.user_id')
                ->where($where)
                ->field('uc.*,from_unixtime(uc.addtime) as addtime,u.username,u.number')
                ->order('uc.user_crowd_id desc')
                ->paginate(array('list_rows' => $pageSize, 'page' => $page))
                ->toArray();
            return $result = ['code' => 0, 'msg' => '获取成功!', 'data' => $list['data'], 'count' => $list['total'], 'rel' => 1];
        }
        return $this->fetch();
    }

    //添加众筹
    public function add_crowd()
    {
        $user_id = input('id');
        if (request()->isPost()) {
            $data = input('post.');
            $data['addtime'] = time();
            $data['user_id'] = $user_id;
            $num = floatval($data['total']);
            if (bccomp($num, 0, 8) != 1) return ['code' => 2, 'msg' => '请输入正确的数量！'];

            Db::startTrans();
            try {
                // 查询账户信息
                $old_crowd = Db('user_account')->where(['user_id' => $user_id])->field('crowd,crowd_total')->lock(true)->find();//储蓄钱包余额
                $new_crowd = bcadd($old_crowd['crowd'], $num, 8);
                $new_crowd_total = bcadd($old_crowd['crowd_total'], $num, 8);
                //dump($new_crowd_total);die;

                //更新user_account
                Db('user_account')->where(['user_id' => $user_id])->update([
                    'crowd' => $new_crowd,
                    'crowd_total' => $new_crowd_total,
                ]);

                $time = time();
                //user_crowd表添加数据
                $user_crowd_id = Db('user_crowd')->insertGetId([
                    'user_id' => $user_id,
                    'total' => $num,
                    'balance' => $num,
                    'addtime' => $time,
                    'status' => 0,
                ]);
                //log_crowd表添加日志
                Db('log_crowd')->insertGetId([
                    'user_id' => $user_id,
                    'type' => 1,
                    'num' => $num,
                    'amount' => $old_crowd['crowd'],
                    'balance' => $new_crowd,
                    'addtime' => $time,
                    'status' => 1,
                    'remark' => '',
                    'union' => 'user_crowd',
                    'union_id' => $user_crowd_id,
                ]);
                //添加操作日志
                db('log_action')->insert(array('admin_name' => $_SESSION['session']['username'], 'type' => 43, 'union' => 'user_crowd', 'union_id' => $user_crowd_id, 'object' => '添加众筹' . $user_id . '_' . $num, 'last_time' => time(), 'ip' => request()->ip(1)));

                Db::commit();
                $this->up_node($user_id);
                $result['msg'] = '添加成功!';
                $result['url'] = url('user_crowd_list', array('id' => $user_id));
                $result['code'] = 1;
                return $result;
            } catch (Exception $e) {
                Log::error($e->getMessage());
                Db::rollback();
                return ['code' => 1, 'msg' => '添加失败！', 'data' => $e->getMessage()];
            }
        } else {
            $user = db('users')->where('user_id', $user_id)->field('user_id,username')->find();
            $this->assign('title', lang('add') . "众筹");
            $this->assign('info', 'null');
            $this->assign('user', $user);
            return $this->fetch();
        }
    }

    public function bean()
    {
        $text = input('post.');
        if ($text == '') {
            return ['code' => 0, 'msg' => '请输入需要拨豆豆的手机号码！'];
        }
        $arr = explode(" ", $this->trimall($text['text']));
        $data = [];
        for ($x = 0; $x < count($arr); $x++) {
            if (strlen($arr[$x]) > 10) {
                $data[]['mobile'] = $arr[$x];
            }
        }

        if (Db('fid_user')->insertAll($data)) {
//        $this->add_fid();
            $result['msg'] = '拨豆豆成功!';
            $result['code'] = 1;
            return $result;
        } else {
            return ['code' => 0, 'msg' => '添加失败！'];
        }

    }

    function trimall($str)
    {
        $qian = array(" ", "　", "\t", "\n", "\r");
        return str_replace($qian, ' ', $str);
    }

    //添加FID
    public function add_fid()
    {
        $data = db('fid_user')->where(['is_add' => 0])->group('mobile')->select();

        foreach ($data as $v) {
            $user_id = db('users')->where(['mobile' => $v['mobile']])->value('user_id');
            if ($user_id) {
                $old_balance = db('user_coin')->where(['user_id' => $user_id, 'coin_id' => 24])->value('balance');
                if ($old_balance < 5000) {
                    db('fid_user')->where(['mobile' => $v['mobile']])->update(['is_add' => 1]);
                    $new_balance = bcadd($old_balance, 5000, 8);
                    //更新余额
                    db('user_coin')->where(['user_id' => $user_id, 'coin_id' => 24])->update(['balance' => $new_balance]);
                    //添加日志
                    Db('log_coin')->insertGetId([
                        'user_id' => $user_id,
                        'coin_id' => 24,
                        'type' => 82,
                        'num' => 5000,
                        'amount' => $old_balance,
                        'balance' => $new_balance,
                        'addtime' => time(),
                        'status' => 1,
                        'remark' => 'FID会员增加5000',
                    ]);
                } else {
                    db('fid_user')->where(['mobile' => $v['mobile']])->update(['is_add' => 3]);
                }
            }
        }
        return ['code' => 1, 'msg' => '操作成功！'];
    }

}