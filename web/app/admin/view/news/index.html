{include file="common/head"/}
<div class="admin-main layui-anim layui-anim-upbit">
  <fieldset class="layui-elem-field layui-field-title">
    <legend>新闻资讯</legend>
  </fieldset>
  <div class="demoTable">
    <div class="layui-inline">
      <input class="layui-input" name="key" id="key" placeholder="{:lang('pleaseEnter')}关键字">
    </div>
    <button class="layui-btn" id="search" data-type="reload">{:lang('search')}</button>
    <a href="{:url('index')}" class="layui-btn">显示全部</a>
    <a href="{:url('add')}" class="layui-btn" style="float:right;"><i class="fa fa-plus" aria-hidden="true"></i>添加公告</a>
    <div style="clear: both;"></div>
  </div>
  <table class="layui-table" id="list" lay-filter="list"></table>
</div>
{include file="common/foot"/}
<script>
  layui.use(['table', 'form'], function () {
    var table = layui.table,
      form = layui.form,
      $ = layui.jquery;

    var tableIn = table.render({
      id: 'id',
      elem: '#list',
      url: '{:url("index")}',
      method: 'post',
      page: true,
      cols: [[
        {checkbox: true, fixed: true},
        {field: 'id', title: '{:lang("id")}', width: 80, fixed: true},
        {
          field: 'title', title: '标题', width: 200, templet: function (d) {
            return d.title + (d.image ? '<img src="__ADMIN__/images/image.gif" onmouseover="layer.tips(\'<img src={:config("url.oss")}' + d.image + ' width=180>\',this,{tips: [1, \'#fff\']});" onmouseout="layer.closeAll();">' : '');
          }
        },
        {field: 'source', title: '来源', width: 200},
        {
          field: 'top', align: 'center', title: '置顶', width: 120, sort: true, templet: function (d) {
            return '<input type="checkbox" name="top" value="' + d.id + '" lay-skin="switch" lay-text="置顶|普通" lay-filter="top" ' + (d.top ? 'checked' : '') + '>';
          }
        },
        {
          field: 'sort', title: '排序', width: 120, templet: function (d) {
            return '<input name="sort" data-id="' + d.id + '" class="list_order layui-input" value="' + d.sort + '" size="10"/>';
          }
        },
        {field: 'addtime', title: '{:lang("add")}{:lang("time")}', width: 150},
        {
          field: 'status', align: 'center', title: '{:lang("status")}', width: 120, sort: true, templet: function (d) {
            return '<input type="checkbox" name="status" value="' + d.id + '" lay-skin="switch" lay-text="通过|未审" lay-filter="status" ' + (d.status ? 'checked' : '') + '>';
          }
        },
        {
          width: 160, title: '操作', align: 'center', templet: function (d) {
            return '<a href="{:url(\'edit\')}?id=' + d.id + '" class="layui-btn layui-btn-xs">编辑</a>\n' + '<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>';
          }
        }
      ]],
      limit: 10
    });

    form.on('switch(status)', function (obj) {
      loading = layer.load(1, {shade: [0.1, '#fff']});
      var id = this.value;
      $.post('{:url("status")}', {'id': id}, function (res) {
        layer.close(loading);
        if (res.code == 1) {
          tableIn.reload();
        } else {
          layer.msg(res.msg, {time: 1000, icon: 2});
          return false;
        }
      })
    });

    form.on('switch(top)', function (obj) {
      loading = layer.load(1, {shade: [0.1, '#fff']});
      var id = this.value;
      $.post('{:url("top")}', {'id': id}, function (res) {
        layer.close(loading);
        if (res.code == 1) {
          tableIn.reload();
        } else {
          layer.msg(res.msg, {time: 1000, icon: 2});
          return false;
        }
      })
    });

    //搜索
    $('#search').on('click', function () {
      var key = $('#key').val();
      if ($.trim(key) === '') {
        layer.msg('{:lang("pleaseEnter")}关键字！', {icon: 0});
        return;
      }
      tableIn.reload({
        where: {key: key}
      });
    });

    $('body').on('blur', '.list_order', function () {
      var id = $(this).data('id');
      var sort = $(this).val();
      var loading = layer.load(1, {shade: [0.1, '#fff']});
      $.post('{:url("sort")}', {id: id, sort: sort}, function (res) {
        layer.close(loading);
        if (res.code === 1) {
          layer.msg(res.msg, {time: 1000, icon: 1});
          tableIn.reload();
        } else {
          layer.msg(res.msg, {time: 1000, icon: 2});
        }
      })
    });

    table.on('tool(list)', function (obj) {
      var data = obj.data;
      if (obj.event === 'status') {
        var loading = layer.load(1, {shade: [0.1, '#fff']});
        $.post('{:url("status")}', {'id': data.id}, function (res) {
          layer.close(loading);
          if (res.status === 1) {
            obj.update({
              status: '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="status">开启</a>'
            });
          } else {
            obj.update({
              status: '<a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="status">关闭</a>'
            });
          }

        })
      } else if (obj.event === 'del') {
        layer.confirm('您确定要删除该广告吗？', function (index) {
          var loading = layer.load(1, {shade: [0.1, '#fff']});
          $.post("{:url('del')}", {id: data.id}, function (res) {
            layer.close(loading);
            if (res.code === 1) {
              layer.msg(res.msg, {time: 1000, icon: 1});
              tableIn.reload();
            } else {
              layer.msg('操作失败！', {time: 1000, icon: 2});
            }
          });
          layer.close(index);
        });
      }
    });

  })
</script>